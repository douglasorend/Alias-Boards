<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>SleePy:alias_board</id>
	<version>1.4</version>
	<file name="$sourcedir/Subs-BoardIndex.php">
		<operation>
			<search position="after"><![CDATA[	// For performance, track the latest post while going through the boards.
]]></search>
			<add><![CDATA[
	// Simply clean these
	$board_array = $child_array = $alias_boards = $alias_childs = $find_alias_childs = array();

	// Is our Aliases in a cache?
	if (($cached_alias_boards_cats = cache_get_data('alias_boards_cats', !empty($modSettings['alias_cache_time']) ? $modSettings['alias_cache_time'] : 3600)) == null)
	{
		// Find our Aliases.
		$result_alias = $smcFunc['db_query']('', "
			SELECT
				alias_cat, alias_child, id_board, id_cat
			FROM {db_prefix}boards AS b
			WHERE {query_see_board}
				AND	(alias_cat != {string:empty_string}
					OR
					alias_child != {string:empty_string})
				" . (empty($modSettings['countChildPosts']) ? "
				AND b.child_level <= 1" : ''),
			array(
				'empty_string' => '',
				));

		// Do a loopy loop, orginize and set them in arrays.
		while ($row_alias = $smcFunc['db_fetch_assoc']($result_alias))
		{
			// Are we a cat?
			if(!empty($row_alias['alias_cat']))
			{
				// Boom, now you know.
				$tmp = explode(',', $row_alias['alias_cat']);

				// For every piece, lets set.
				foreach($tmp as $kitty)
					$alias_boards[$row_alias['id_board']][$kitty] = $row_alias['id_cat'];
			}
			// Is it going to a board?
			if(!empty($row_alias['alias_child']))
			{
				// Boom, now you know.
				$tmp = explode(',', $row_alias['alias_child']);

				// For every piece, lets set.
				foreach($tmp as $board)
				{
					//				original board	   aliased board	Original cat.
					$alias_childs[$row_alias['id_board']][$board] = array('original' => $row_alias['id_cat'], 'aliased' => 0);
					$find_alias_childs[$board][$row_alias['id_board']] = $row_alias['id_board'];
				}
			}
		}
		$smcFunc['db_free_result']($result_alias);

		if (!empty($find_alias_childs))
		{
			$request = $smcFunc['db_query']('', '
				SELECT id_board, id_cat, id_parent
				FROM {db_prefix}boards as b
				WHERE {query_see_board}
					AND b.id_board IN ({array_int:aliased_childs})',
				array(
					'aliased_childs' => array_keys($find_alias_childs),
			));

			while ($row_child = $smcFunc['db_fetch_assoc']($request))
				if (isset($find_alias_childs[$row_child['id_board']]))
					foreach ($find_alias_childs[$row_child['id_board']] as $id_board => $fakev)
						$alias_childs[$id_board][$row_child['id_board']]['aliased'] = $row_child['id_cat'];
			$smcFunc['db_free_result']($request);
		}

		// Store in cache
		if (!empty($modSettings['cache_enable']))
		{
			$cached_alias_boards_cats = array('alias_boards' => $alias_boards, 'alias_childs' => $alias_childs);
			cache_put_data('alias_boards_cats', $cached_alias_boards_cats, !empty($modSettings['alias_cache_time']) ? $modSettings['alias_cache_time'] : 3600);
		}	
	}
	else
	{
		// Get them out of there.
		$alias_boards = $cached_alias_boards_cats['alias_boards'];
		$alias_childs = $cached_alias_boards_cats['alias_childs'];
	}

]]></add>
		</operation>
		<operation>

			<search position="after"><![CDATA[	// By now we should know the most recent post...if we wanna know it that is.
]]></search>
			<add><![CDATA[
	// Doing boards to other cateogires?
	if (!empty($alias_boards) && isset($categories))
	{
		foreach ($alias_boards as $board => $cats)
		{
			foreach ($cats as $aliased_cat => $original)
			{
				$categories[$aliased_cat]['boards'][$board] = $categories[$original]['boards'][$board];

				$categories[$aliased_cat]['boards'][$board]['children_new'] |= !empty($categories[$original]['boards'][$board]['children_new']) ? $categories[$original]['boards'][$board]['children_new'] : FALSE;
				$categories[$aliased_cat]['boards'][$board]['new'] |= !empty($categories[$original]['boards'][$board]['new']) ? $categories[$original]['boards'][$board]['new'] : FALSE;
			}
		}
	}

	// Boards on the index to other boards on the index?
	if (!empty($alias_childs))
		foreach ($alias_childs as $board => $junk)
			foreach ($junk as $aliased_board => $cats)
				if (isset($categories))
					$categories[$cats['aliased']]['boards'][$aliased_board]['children'][$board] = $categories[$cats['original']]['boards'][$board];
]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManageBoards.php">
		<operation>
			<search position="before"><![CDATA[
		$context['board'] = array(
			'is_new' => true,
]]></search>
			<add><![CDATA[
			'alias_cat' => '',
			'alias_child' => '',

]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[		$context['board']['no_children'] = empty($boards[$_REQUEST['boardid']]['tree']['children']);
]]></search>
			<add><![CDATA[		$context['board']['alias_cat'] = $boards[$_REQUEST['boardid']]['alias_cat'];
		$context['board']['alias_child'] = $boards[$_REQUEST['boardid']]['alias_child'];

]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[			'name' => $tree['node']['name'],
			'selected' => $catID == $curBoard['category']
		);
]]></search>
			<add><![CDATA[
			'real_id' => $catID,
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[		$boardOptions['override_theme'] = isset($_POST['override_theme']);
		$boardOptions['board_theme'] = (int) $_POST['boardtheme'];
		$boardOptions['access_groups'] = array();
]]></search>
			<add><![CDATA[
		$boardOptions['alias_cat'] = isset($_POST['alias_cat']) ? implode(',', $_POST['alias_cat']) : '';
		$boardOptions['alias_child'] = isset($_POST['alias_child']) ? implode(',', $_POST['alias_child']) : '';
        cache_put_data('alias_boards_cats', null);

]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManageSettings.php">
		<operation>
			<search position="before"><![CDATA[
		// Mod authors, add any settings UNDER this line. Include a comma at the end of the line and don't remove this statement!!
]]></search>
			<add><![CDATA[
			// Alais Boards/Cats Cache time???
		'',
			array('int', 'alias_cache_time'),
]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-Boards.php">
		<operation>
			<search position="after"><![CDATA[	// Do the updates (if any).
	if (!empty($boardUpdates))
]]></search>
			<add><![CDATA[
	// Set the Aliased categories.
	if (isset($boardOptions['alias_cat']))
		$boardUpdates[] = 'alias_cat = "' . $boardOptions['alias_cat'] . '"';

	// Set the Aliased boards.
	if (isset($boardOptions['alias_child']))
		$boardUpdates[] = 'alias_child = "' . $boardOptions['alias_child'] . '"';

]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			b.num_posts, b.num_topics, c.id_cat, c.name AS cat_name, c.cat_order, c.can_collapse
]]></search>
			<add><![CDATA[			b.num_posts, b.num_topics, c.id_cat, c.name AS cat_name, c.cat_order, c.can_collapse, b.alias_cat, b.alias_child
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[				'parent' => $row['id_parent'],
				'level' => $row['child_level'],
				'order' => $row['board_order'],
]]></search>
			<add><![CDATA[
				'alias_cat' => explode(',', $row['alias_cat']),
				'alias_child' => explode(',', $row['alias_child']),

]]></add>
		</operation>
	</file>
	<file name="$themedir/ManageBoards.template.php">
		<operation>
			<search position="after"><![CDATA[	// Here the user can choose to force this board to use a theme other than the default theme for the forum.
]]></search>
			<add><![CDATA[
	// We need some globals that SMF doesn't have.
	global $cat_tree, $boards;

	echo '
					<div>
						<dl class="settings">
							<dt>
								<strong>', $txt['alias_cat_title'], '</strong><br />
								<span class="smalltext">', $txt['alias_cat_desc'], '</span><br />
							</dt>
							<dd>
								<select name="alias_cat[]" multiple="multiple">
									<option value="">', $txt['no_cat_selected'], '</option>';
	foreach ($cat_tree as $category)
		echo '
									<option', !isset($context['board']['is_new']) && in_array($category['node']['id'], $context['board']['alias_cat']) ? ' selected="selected"' : '', ' value="', $category['node']['id'], '">', $category['node']['name'], '</option>';
	echo '
								</select>
							</dd>
							<dt>
								<strong>', $txt['alias_child_title'], '</strong><br />
								<span class="smalltext">', $txt['alias_child_desc'], '</span><br />
							</dt>
							<dd>
								<select name="alias_child[]" multiple="multiple">
									<option value="">', $txt['no_boards_selected'], '</option>';
	foreach ($boards as $board)
		echo '
									<option', !isset($context['board']['is_new']) && in_array($board['id'], $context['board']['alias_child']) ? ' selected="selected"' : '', ' value="', $board['id'], '">', $board['name'], '</option>';
	echo '
								</select>
							</dd>
						</dl>
					</div>';
]]></add>
		</operation>
	</file>
	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[
$txt['alias_cat_title'] = 'Alias Categories';
$txt['alias_cat_desc'] = 'Enter the <b>Category</b> IDs that you want this board to also appear in.';
$txt['alias_child_title'] = 'Alias Boards';
$txt['alias_child_desc'] = 'Enter the <b>Board</b> IDs that you want this board to also appear in.';
$txt['no_cat_selected'] = 'Do not alias to any category';
$txt['no_boards_selected'] = 'Do not alias to any board';
$txt['alias_cache_time'] = 'How long should we cache the Alias board arrays? (In seconds) (Default: 3600 Secs/1 Hour)';
]]></add>
		</operation>
	</file>
	<file name="$languagedir/Modifications.english_utf8.php" error="skip">
		<operation>
			<search position="end" />
			<add><![CDATA[$txt['alias_cat_title'] = 'Alias Categories';
$txt['alias_cat_desc'] = 'Enter the <b>Category</b> IDs that you want this board to also appear in.';
$txt['alias_child_title'] = 'Alias Boards';
$txt['alias_child_desc'] = 'Enter the <b>Board</b> IDs that you want this board to also appear in.';
$txt['no_cat_selected'] = 'Do not alias to any category';
$txt['no_boards_selected'] = 'Do not alias to any board';
$txt['alias_cache_time'] = 'How long should we cache the Alias board arrays? (In seconds) (Default: 3600 Secs/1 Hour)';
]]></add>
		</operation>
	</file>
</modification>